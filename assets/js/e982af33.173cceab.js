"use strict";(self.webpackChunk_orca_so_whirlpools_docs=self.webpackChunk_orca_so_whirlpools_docs||[]).push([[288],{1184:(e,t,n)=>{n.d(t,{R:()=>i,x:()=>s});var o=n(4041);const r={},a=o.createContext(r);function i(e){const t=o.useContext(a);return o.useMemo((function(){return"function"==typeof e?e(t):{...t,...e}}),[t,e])}function s(e){let t;return t=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:i(e.components),o.createElement(a.Provider,{value:t},e.children)}},4326:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>l,contentTitle:()=>s,default:()=>d,frontMatter:()=>i,metadata:()=>o,toc:()=>c});const o=JSON.parse('{"id":"Legacy SDK/Performing Swaps","title":"Performing Swaps","description":"Before we begin, you should have an understanding of what ticks are and how they are stored. If not, you can reference Price & Ticks.","source":"@site/docs/04-Legacy SDK/04-Performing Swaps.md","sourceDirName":"04-Legacy SDK","slug":"/Legacy SDK/Performing Swaps","permalink":"/Legacy SDK/Performing Swaps","draft":false,"unlisted":false,"editUrl":"https://github.com/orca-so/whirlpools/tree/main/docs/whirlpool/docs/04-Legacy SDK/04-Performing Swaps.md","tags":[],"version":"current","sidebarPosition":4,"frontMatter":{},"sidebar":"sidebar","previous":{"title":"Identifying Wallet Positions","permalink":"/Legacy SDK/Position Management/Identifying Wallet Positions"},"next":{"title":"Tutorial: Tour de Whirlpool","permalink":"/Legacy SDK/Tour de Whirlpool/Overview"}}');var r=n(1085),a=n(1184);const i={},s="Performing Swaps",l={},c=[{value:"Trade with WhirlpoolClient",id:"trade-with-whirlpoolclient",level:2},{value:"Generating a swap quote by input or output token",id:"generating-a-swap-quote-by-input-or-output-token",level:3},{value:"Adding a developer fee to the swap",id:"adding-a-developer-fee-to-the-swap",level:3},{value:"The Manual Way",id:"the-manual-way",level:2},{value:"Trade Parameters",id:"trade-parameters",level:3},{value:"Tick Arrays",id:"tick-arrays",level:3},{value:"Common Usage Examples",id:"common-usage-examples",level:3}];function h(e){const t={a:"a",blockquote:"blockquote",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",li:"li",ol:"ol",p:"p",pre:"pre",ul:"ul",...(0,a.R)(),...e.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(t.header,{children:(0,r.jsx)(t.h1,{id:"performing-swaps",children:"Performing Swaps"})}),"\n",(0,r.jsxs)(t.p,{children:["Before we begin, you should have an understanding of what ticks are and how they are stored. If not, you can reference ",(0,r.jsx)(t.a,{href:"/Architecture%20Overview/Price%20&%20Ticks",children:"Price & Ticks"}),"."]}),"\n",(0,r.jsx)(t.h2,{id:"trade-with-whirlpoolclient",children:"Trade with WhirlpoolClient"}),"\n",(0,r.jsx)(t.p,{children:"You can use the swap quote and WhirlpoolClient to easily perform a trade."}),"\n",(0,r.jsxs)(t.p,{children:["Learn more about ",(0,r.jsx)(t.code,{children:"amountSpecifiedIsInput"})," , ",(0,r.jsx)(t.code,{children:"aToB"})," in the section below."]}),"\n",(0,r.jsx)(t.h3,{id:"generating-a-swap-quote-by-input-or-output-token",children:"Generating a swap quote by input or output token"}),"\n",(0,r.jsx)(t.p,{children:"Generate quote with one of the quote functions:"}),"\n",(0,r.jsxs)(t.ul,{children:["\n",(0,r.jsxs)(t.li,{children:[(0,r.jsx)(t.a,{href:"https://dev.orca.so/legacy/functions/swapQuoteByInputToken.html",children:(0,r.jsx)(t.code,{children:"swapQuoteByInputToken"})})," if you want an estimate on the amount of outputToken received on an amount of inputToken."]}),"\n",(0,r.jsxs)(t.li,{children:[(0,r.jsx)(t.a,{href:"https://dev.orca.so/legacy/functions/swapQuoteByInputToken.html",children:(0,r.jsx)(t.code,{children:"swapQuoteByOutputToken"})})," if you want an estimate on the amount of inputToken needed to receive a set amount of outputToken."]}),"\n"]}),"\n",(0,r.jsxs)(t.p,{children:["The resulting ",(0,r.jsx)(t.a,{href:"https://dev.orca.so/legacy/types/SwapQuote.html",children:(0,r.jsx)(t.code,{children:"SwapQuote"})})," object contains the estimations on the expected amount of tokenIn, tokenOut, fees, projected ending sqrtPrice. When you are ready, plug the quote object directly into the swapIx to perform the trade."]}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{className:"language-tsx",children:"const whirlpoolPda = PDAUtil.getWhirlpool(...);\nconst whirlpoolClient = buildWhirlpoolClient(ctx);\nconst whirlpool = await whirlpoolClient.getPool(whirlpoolPda.publicKey, true);\n// use getData or refreshData, depending on whether you think your data is stale.\nconst whirlpoolData = await whirlpool.getData();\n\nconst inputTokenQuote = await swapQuoteByInputToken(\n  whirlpool,\n  whirlpoolData.tokenMintB,\n  new u64(190000000),\n  Percentage.fromFraction(1, 1000), // 0.1%\n  ctx.program.programId,\n  fetcher,\n  true\n);\n\n// Send out the transaction\nconst txId = await (await whirlpool.swap(inputTokenQuote)).buildAndExecute();\n"})}),"\n",(0,r.jsx)(t.h3,{id:"adding-a-developer-fee-to-the-swap",children:"Adding a developer fee to the swap"}),"\n",(0,r.jsxs)(t.p,{children:["The SDK also provides ",(0,r.jsx)(t.a,{href:"https://dev.orca.so/legacy/functions/swapQuoteByInputTokenWithDevFees.html",children:(0,r.jsx)(t.code,{children:"swapQuoteByInputTokenWithDevFees"})})," & ",(0,r.jsx)(t.a,{href:"https://dev.orca.so/legacy/interfaces/Whirlpool.html#swapWithDevFees",children:(0,r.jsx)(t.code,{children:"swapWithDevFees"})})," function to let developers take a fee as a percentage of the input asset. This feature is a convenient way to calculate the percentage, build a transfer instruction for the fee, and use the remaining input asset in a swap instruction."]}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{className:"language-tsx",children:"// Wallet used to collect developer fees\nconst DEV_WALLET = new PublicKey(...)\n\nconst whirlpoolPda = PDAUtil.getWhirlpool(...);\nconst whirlpoolClient = buildWhirlpoolClient(ctx);\nconst whirlpool = await whirlpoolClient.getPool(whirlpoolPda.publicKey, true);\n// use getData or refreshData, depending on whether you think your data is stale.\nconst whirlpoolData = await whirlpool.getData();\n\nconst inputTokenQuote = await swapQuoteByInputTokenWithDevFees(\n  whirlpool,\n  whirlpoolData.tokenMintB,\n  new u64(190000000),\n  Percentage.fromFraction(1, 1000), // 0.1%\n  ctx.program.programId,\n  fetcher,\n  Percentage.fromFraction(2, 1000), // 0.2% of the input asset will be sent to DEV_WALLET\n  true\n);\n\n// Send out the transaction\nconst txId = await (await whirlpool.swapWithDevFees(inputTokenQuote, DEV_WALLET)).buildAndExecute();\n"})}),"\n",(0,r.jsxs)(t.blockquote,{children:["\n",(0,r.jsx)(t.p,{children:"\u2139\ufe0f The developer fee transfer is performed by the SPL Token program or System program, and not the Whirlpools program."}),"\n"]}),"\n",(0,r.jsxs)(t.p,{children:["Best practice is to ",(0,r.jsx)(t.a,{href:"https://solanacookbook.com/references/token.html#how-to-create-a-token-account",children:"pre-create Associated Token Accounts (ATA)"})," for each token type which will be sent to the developer wallet. Also, if the fee will be payed in SOL, make sure that the developer wallet has at least 0.001 SOL to ensure that the wallet account will meet rent exemption."]}),"\n",(0,r.jsx)(t.h2,{id:"the-manual-way",children:"The Manual Way"}),"\n",(0,r.jsx)(t.p,{children:"Manually constructing your own parameters gives you more flexibility in defining the boundaries of your trade."}),"\n",(0,r.jsx)(t.h3,{id:"trade-parameters",children:"Trade Parameters"}),"\n",(0,r.jsxs)(t.p,{children:["The ",(0,r.jsx)(t.a,{href:"https://dev.orca.so/legacy/interfaces/Whirlpool.html#swap",children:(0,r.jsx)(t.code,{children:"swap"})})," instruction requires the following input (and other common accounts) to execute the trade."]}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{className:"language-tsx",children:"export type SwapInput = {\n  amount: u64;\n  otherAmountThreshold: u64;\n  sqrtPriceLimit: BN;\n  amountSpecifiedIsInput: boolean;\n  aToB: boolean;\n  tickArray0: PublicKey;\n  tickArray1: PublicKey;\n  tickArray2: PublicKey;\n};\n"})}),"\n",(0,r.jsxs)(t.ul,{children:["\n",(0,r.jsxs)(t.li,{children:["Decide the trade direction with ",(0,r.jsx)(t.code,{children:"aToB"}),"\n",(0,r.jsxs)(t.ul,{children:["\n",(0,r.jsx)(t.li,{children:"If true, you are trading from token A to B"}),"\n",(0,r.jsx)(t.li,{children:"If false, you are trading from token B to A"}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(t.li,{children:["Decide the token you would like to cap with ",(0,r.jsx)(t.code,{children:"amountSpecifiedIsInput"}),"\n",(0,r.jsxs)(t.ul,{children:["\n",(0,r.jsxs)(t.li,{children:["If true, ",(0,r.jsx)(t.code,{children:"amount"})," is the value representing the token being traded from. This amount is subject to trade fees before the trade calculation."]}),"\n",(0,r.jsxs)(t.li,{children:["If false, ",(0,r.jsx)(t.code,{children:"amount"})," is the value representing the token being traded to. This amount is the required token out amount from a trade after fees."]}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(t.li,{children:["Decide whether you want to cap the other token of the trade using ",(0,r.jsx)(t.code,{children:"otherAmountThreshold"}),"\n",(0,r.jsxs)(t.ul,{children:["\n",(0,r.jsxs)(t.li,{children:["If ",(0,r.jsx)(t.code,{children:"amountSpecifiedIsInput"})," is true, this amount represents the minimum amount of output token expected from this trade. If you do not want to cap, use 0."]}),"\n",(0,r.jsxs)(t.li,{children:["If ",(0,r.jsx)(t.code,{children:"amountSpecifiedIsInput"})," is false, this amount represents the maximum amount of input token that can be used to trade to an expected amount of the output token. If you do not want to cap, use the maximum amount of tokens in your wallet."]}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(t.li,{children:["Decide the price limit that you would like to cap this trade to with ",(0,r.jsx)(t.code,{children:"sqrtPriceLimit"}),".","\n",(0,r.jsxs)(t.ul,{children:["\n",(0,r.jsxs)(t.li,{children:["If ",(0,r.jsx)(t.code,{children:"aToB"})," is true, the trade will push the price lower. This amount is minimum sqrt-price that the trade will trade to if input token amount is sufficient."]}),"\n",(0,r.jsxs)(t.li,{children:["If ",(0,r.jsx)(t.code,{children:"aToB"})," is false, the trade will push the price higher. This amount is the maximum sqrt-price that the trade will trade to if the the input token amount is sufficient."]}),"\n",(0,r.jsxs)(t.li,{children:["If you don't have a cap and want to trade as much as you've defined with ",(0,r.jsx)(t.code,{children:"amount"})," and ",(0,r.jsx)(t.code,{children:"otherAmountThreshold"}),", use the minimum price of your tick-array range for ",(0,r.jsx)(t.code,{children:"bToA"})," and maximum price of your tick-range for ",(0,r.jsx)(t.code,{children:"aToB"}),". If you don't mind hitting tick-array errors or you know your swap won't move the price too much, you can use ",(0,r.jsx)(t.a,{href:"https://dev.orca.so/legacy/variables/MIN_SQRT_PRICE.html",children:(0,r.jsx)(t.code,{children:"MIN_SQRT_PRICE"})})," or ",(0,r.jsx)(t.a,{href:"https://dev.orca.so/legacy/variables/MAX_SQRT_PRICE.html",children:(0,r.jsx)(t.code,{children:"MAX_SQRT_PRICE"})}),"."]}),"\n",(0,r.jsxs)(t.li,{children:["sqrt-price is a x64 number. So your number would need to multiplied by 2^64. Use ",(0,r.jsx)(t.a,{href:"https://dev.orca.so/legacy/classes/PriceMath.html",children:(0,r.jsx)(t.code,{children:"PriceMath"})})," utils here to help you do the conversion."]}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(t.li,{children:[(0,r.jsx)(t.code,{children:"amount"})," and ",(0,r.jsx)(t.code,{children:"otherAmountThreshold"})," are u64 numbers. So make sure you shift your expected token numbers by the token's decimal."]}),"\n"]}),"\n",(0,r.jsx)(t.h3,{id:"tick-arrays",children:"Tick Arrays"}),"\n",(0,r.jsxs)(t.p,{children:["The tick-array parameters are a sequence of tick-arrays that your swap may traverse through. ",(0,r.jsx)(t.code,{children:"tickArray0"})," will always be the PublicKey of the TickArray that houses the current tick-index."]}),"\n",(0,r.jsxs)(t.p,{children:["In almost all cases, you can use the ",(0,r.jsx)(t.a,{href:"https://dev.orca.so/legacy/classes/SwapUtils.html#getTickArrays",children:(0,r.jsx)(t.code,{children:"SwapUtils.getTickArrays"})})," to generate the sequence of tick-arrays that you need."]}),"\n",(0,r.jsx)(t.p,{children:"If you opt for building it yourself and you know that your swap is small enough that it's unlikely to traverse through an array, simply provide the same tickArray0 account for all 3 accounts. Once you have the sequence of tick-array public keys, you can use the AccountFetcher to check that the tick-arrays are initialized."}),"\n",(0,r.jsxs)(t.p,{children:["To learn more about tick-arrays and how its traversal works, read ",(0,r.jsx)(t.a,{href:"/Architecture%20Overview/Understanding%20Tick%20Arrays",children:"Understanding Tick Arrays"}),"."]}),"\n",(0,r.jsx)(t.h3,{id:"common-usage-examples",children:"Common Usage Examples"}),"\n",(0,r.jsx)(t.p,{children:"Assume all tokens below have a decimal of 6"}),"\n",(0,r.jsxs)(t.ol,{children:["\n",(0,r.jsxs)(t.li,{children:["Trading 100 token A for some amount of token B.","\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{className:"language-tsx",children:"aToB = true\namount = 100 * Math.pow(10, 6)\namountSpecifiedIsInput  = true\notherAmountThreshold = 0\nsqrt_price_limit = MIN_SQRT_PRICE\n"})}),"\n"]}),"\n",(0,r.jsxs)(t.li,{children:["Trading a max amount of 50 token B for 100 token A","\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{className:"language-tsx",children:"aToB = false\namount = 100 * Math.pow(10, 6)\namountSpecifiedIsInput  = false\notherAmountThreshold = 50\nsqrt_price_limit = MAX_SQRT_PRICE\n"})}),"\n"]}),"\n",(0,r.jsxs)(t.li,{children:["Trade whatever amount needed to move the price from current sqrt-price 50_x64 to sqrt_price 250_x64","\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{className:"language-tsx",children:"aToB = true\namount = maxAmmountWallet\namountSpecifiedIsInput  = true\notherAmountThreshold = 0\nsqrt_price_limit = 250_x64\n"})}),"\n"]}),"\n"]})]})}function d(e={}){const{wrapper:t}={...(0,a.R)(),...e.components};return t?(0,r.jsx)(t,{...e,children:(0,r.jsx)(h,{...e})}):h(e)}}}]);